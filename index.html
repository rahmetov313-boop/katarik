<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞—Ç–∞—Ä–∏–∫</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Fira+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0e17;
    --surface: #1a1928;
    --card-bg: #f5f0e8;
    --card-border: #d4c9a8;
    --accent: #e8a045;
    --accent2: #c0392b;
    --green: #27ae60;
    --text: #e8e0d0;
    --text-dim: #7a7060;
    --table: #1c3a2a;
    --table-felt: #1e4033;
    --gold: #d4a017;
    --radius: 8px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Fira Mono', monospace; min-height: 100vh; overflow: hidden; }

  #lobby { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; background: radial-gradient(ellipse at center, #1a2a1e 0%, #0f0e17 70%); }
  .logo { font-family: 'Playfair Display', serif; font-size: clamp(3rem, 8vw, 6rem); font-weight: 900; letter-spacing: 0.05em; color: var(--accent); text-shadow: 0 0 40px rgba(232,160,69,0.4), 0 4px 0 #8a5a0a; margin-bottom: 0.2em; }
  .logo span { color: var(--accent2); }
  .subtitle { font-size: 0.85rem; color: var(--text-dim); letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 2.5rem; }
  .lobby-card { background: var(--surface); border: 1px solid #2e2c40; border-radius: 12px; padding: 2rem; width: 100%; max-width: 420px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
  .field-group { margin-bottom: 1.2rem; }
  .field-group label { display: block; font-size: 0.7rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.4rem; }
  .field-group input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid #2e2c40; border-radius: var(--radius); color: var(--text); font-family: 'Fira Mono', monospace; font-size: 1rem; padding: 0.7rem 1rem; outline: none; transition: border-color 0.2s; }
  .field-group input:focus { border-color: var(--accent); }
  .btn { width: 100%; padding: 0.85rem; border: none; border-radius: var(--radius); font-family: 'Fira Mono', monospace; font-size: 0.95rem; font-weight: 500; cursor: pointer; letter-spacing: 0.05em; transition: all 0.2s; }
  .btn-primary { background: var(--accent); color: #0f0e17; }
  .btn-primary:hover { background: #f0b060; transform: translateY(-1px); }
  .btn-secondary { background: transparent; border: 1px solid var(--accent); color: var(--accent); margin-top: 0.5rem; }
  .btn-secondary:hover { background: rgba(232,160,69,0.1); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .lobby-players { margin-top: 1.5rem; border-top: 1px solid #2e2c40; padding-top: 1rem; }
  .lobby-player { display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0; font-size: 0.85rem; color: var(--text-dim); }
  .lobby-player::before { content: '‚óÜ'; color: var(--green); font-size: 0.6rem; }

  #game { display: none; width: 100vw; height: 100vh; grid-template-rows: auto 1fr auto auto; grid-template-columns: 1fr 220px; grid-template-areas: "opponents sidebar" "table sidebar" "hand sidebar" "controls sidebar"; gap: 0; overflow: hidden; }
  #opponents-area { grid-area: opponents; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(0,0,0,0.3); flex-wrap: wrap; }
  .player-badge { background: var(--surface); border: 1px solid #2e2c40; border-radius: var(--radius); padding: 0.35rem 0.7rem; font-size: 0.75rem; display: flex; align-items: center; gap: 0.4rem; transition: all 0.3s; }
  .player-badge.active { border-color: var(--accent); box-shadow: 0 0 12px rgba(232,160,69,0.3); background: rgba(232,160,69,0.1); }
  .player-badge.finished { opacity: 0.4; }
  .player-badge .pname { font-weight: 500; color: var(--text); }
  .player-badge .pcards { color: var(--text-dim); }
  .player-badge .prank { color: var(--gold); font-weight: 700; }
  .turn-indicator { width: 7px; height: 7px; border-radius: 50%; background: #333; flex-shrink: 0; }
  .player-badge.active .turn-indicator { background: var(--accent); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

  #table-area { grid-area: table; background: var(--table); background-image: radial-gradient(ellipse at center, var(--table-felt) 0%, #152a1e 100%); border-top: 2px solid #1a3025; border-bottom: 2px solid #1a3025; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
  #table-area::before { content: ''; position: absolute; inset: 0; background-image: repeating-linear-gradient(45deg, transparent, transparent 20px, rgba(255,255,255,0.01) 20px, rgba(255,255,255,0.01) 21px); pointer-events: none; }
  .table-label { font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase; color: rgba(255,255,255,0.2); margin-bottom: 0.7rem; }
  .table-combo-info { font-size: 0.75rem; color: var(--accent); letter-spacing: 0.1em; margin-bottom: 0.5rem; min-height: 1.2em; }
  #table-cards { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; max-width: 90%; }

  .card { width: 58px; height: 85px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: 700; cursor: default; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.4); transition: transform 0.15s, box-shadow 0.15s; user-select: none; flex-shrink: 0; }
  .card.red { color: #c0392b; }
  .card.black { color: #1a1a2e; }
  .card.joker-b { color: #1a1a2e; background: linear-gradient(135deg, #f5f0e8 50%, #e0dbd0 100%); }
  .card.joker-r { color: #c0392b; background: linear-gradient(135deg, #f5f0e8 50%, #ffe0d8 100%); }
  .card .rank { font-size: 1rem; line-height: 1; }
  .card .suit { font-size: 0.85rem; line-height: 1; }
  .card .corner { position: absolute; font-size: 0.6rem; line-height: 1.1; font-weight: 700; }
  .card .corner.tl { top: 3px; left: 4px; text-align: left; }
  .card .corner.br { bottom: 3px; right: 4px; text-align: right; transform: rotate(180deg); }

  #hand-area { grid-area: hand; padding: 0.5rem 1rem 0.3rem; background: rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 0.4rem; }
  .hand-label { font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-dim); }
  #hand-cards { display: flex; gap: 4px; flex-wrap: wrap; align-items: flex-end; }
  .hand-card { cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
  .hand-card:hover { transform: translateY(-6px); box-shadow: 0 8px 16px rgba(0,0,0,0.5); }
  .hand-card.selected { transform: translateY(-14px); box-shadow: 0 0 0 2px var(--accent), 0 10px 20px rgba(232,160,69,0.3); }
  .hand-card.disabled { opacity: 0.5; cursor: not-allowed; }
  .hand-card.disabled:hover { transform: none; }

  #controls-area { grid-area: controls; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(0,0,0,0.5); border-top: 1px solid #1e1c2e; }
  .action-btn { padding: 0.5rem 1.2rem; border: none; border-radius: var(--radius); font-family: 'Fira Mono', monospace; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; font-weight: 500; }
  #btn-play { background: var(--green); color: white; }
  #btn-play:hover:not(:disabled) { background: #2ecc71; }
  #btn-pass { background: transparent; border: 1px solid #444; color: var(--text-dim); }
  #btn-pass:hover:not(:disabled) { border-color: var(--accent2); color: var(--accent2); }
  .action-btn:disabled { opacity: 0.35; cursor: not-allowed; }
  .selection-info { flex: 1; font-size: 0.75rem; color: var(--text-dim); padding-left: 0.5rem; }
  .status-msg { font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-dim); white-space: nowrap; }

  #sidebar { grid-area: sidebar; background: rgba(0,0,0,0.4); border-left: 1px solid #1e1c2e; display: flex; flex-direction: column; overflow: hidden; }
  .sidebar-title { padding: 0.6rem 0.8rem; font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-dim); border-bottom: 1px solid #1e1c2e; background: rgba(0,0,0,0.2); }
  #chat-messages { flex: 1; overflow-y: auto; padding: 0.5rem; display: flex; flex-direction: column; gap: 0.3rem; }
  .chat-msg { font-size: 0.72rem; line-height: 1.4; word-break: break-word; }
  .chat-msg .cn { color: var(--accent); font-weight: 700; }
  .chat-msg.system { color: var(--text-dim); font-style: italic; }
  #chat-form { display: flex; border-top: 1px solid #1e1c2e; }
  #chat-input { flex: 1; background: transparent; border: none; color: var(--text); font-family: 'Fira Mono', monospace; font-size: 0.75rem; padding: 0.4rem 0.6rem; outline: none; }
  #chat-send { background: transparent; border: none; color: var(--accent); cursor: pointer; padding: 0 0.6rem; font-size: 1rem; transition: color 0.2s; }
  .start-game-btn { margin: 0.5rem; }

  #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  #overlay.show { display: flex; }
  .overlay-card { background: var(--surface); border: 1px solid #2e2c40; border-radius: 12px; padding: 2.5rem; max-width: 480px; width: 90%; text-align: center; box-shadow: 0 30px 80px rgba(0,0,0,0.7); }
  .overlay-title { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--accent); margin-bottom: 1.5rem; }
  .result-item { display: flex; align-items: center; gap: 0.8rem; padding: 0.5rem 0.8rem; margin-bottom: 0.3rem; border-radius: var(--radius); background: rgba(255,255,255,0.03); }
  .result-rank { font-size: 1.4rem; width: 2rem; text-align: center; }
  .rank-1 { color: var(--gold); } .rank-2 { color: #aaa; } .rank-3 { color: #cd7f32; }
  .result-name { flex: 1; text-align: left; font-size: 0.9rem; }

  .error-toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--accent2); color: white; padding: 0.5rem 1.2rem; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 200; }
  .error-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  @media (max-width: 600px) {
    #game { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto auto auto; grid-template-areas: "opponents" "table" "hand" "controls" "sidebar"; }
    #sidebar { max-height: 150px; }
  }
</style>
</head>
<body>

<div id="lobby">
  <div class="logo">–ö–∞—Ç–∞<span>—Ä–∏–∫</span></div>
  <div class="subtitle">–ö–∞—Ä—Ç–æ—á–Ω–∞—è –∏–≥—Ä–∞ ¬∑ –æ—Ç 3 –¥–æ 9 –∏–≥—Ä–æ–∫–æ–≤</div>
  <div class="lobby-card">
    <div class="field-group">
      <label>–í–∞—à–µ –∏–º—è</label>
      <input type="text" id="input-name" maxlength="20" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" />
    </div>
    <div class="field-group">
      <label>–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</label>
      <input type="text" id="input-room" maxlength="20" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: room1" />
    </div>
    <button class="btn btn-primary" id="btn-connect">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
    <div class="lobby-players" id="lobby-players" style="display:none">
      <div style="font-size:0.7rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.5rem">–ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ</div>
      <div id="lobby-player-list"></div>
      <button class="btn btn-secondary" id="btn-start" style="margin-top:1rem" disabled>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É (–Ω—É–∂–Ω–æ 3+)</button>
    </div>
  </div>
</div>

<div id="game">
  <div id="opponents-area"></div>
  <div id="table-area">
    <div class="table-label">–°—Ç–æ–ª</div>
    <div class="table-combo-info" id="combo-info"></div>
    <div id="table-cards"></div>
  </div>
  <div id="hand-area">
    <div class="hand-label">–í–∞—à–∏ –∫–∞—Ä—Ç—ã ‚Äî <span id="hand-count">0</span></div>
    <div id="hand-cards"></div>
  </div>
  <div id="controls-area">
    <button class="action-btn" id="btn-play" disabled>–ü–æ—Ö–æ–¥–∏—Ç—å</button>
    <button class="action-btn" id="btn-pass" disabled>–ü–∞—Å</button>
    <div class="selection-info" id="selection-info">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—ã</div>
    <div class="status-msg" id="status-msg">–û–∂–∏–¥–∞–Ω–∏–µ</div>
  </div>
  <div id="sidebar">
    <div class="sidebar-title">–ß–∞—Ç</div>
    <div id="chat-messages"></div>
    <div class="start-game-btn">
      <button class="btn btn-secondary" id="btn-start-game" style="display:none;padding:0.4rem;font-size:0.75rem">–ù–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –∏–≥—Ä—É</button>
    </div>
    <form id="chat-form">
      <input type="text" id="chat-input" maxlength="200" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button type="submit" id="chat-send">‚û§</button>
    </form>
  </div>
</div>

<div id="overlay">
  <div class="overlay-card">
    <div class="overlay-title" id="overlay-title">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</div>
    <div id="overlay-results"></div>
    <button class="btn btn-primary" style="margin-top:1.5rem" id="btn-next-game">–°–ª–µ–¥—É—é—â–∞—è –∏–≥—Ä–∞</button>
  </div>
</div>

<div class="error-toast" id="error-toast"></div>

<script>
let ws = null;
let myId = localStorage.getItem('katarik_pid') || null;
let myName = '';
let myRoomId = '';
let hand = [];
let selectedIds = new Set();
let gameState = null;
let isMyTurn = false;

const RED_SUITS = ['‚ô•','‚ô¶'];
function suitColor(suit) {
  if (suit === 'üÉè') return 'joker-b';
  if (suit === 'üÉü') return 'joker-r';
  return RED_SUITS.includes(suit) ? 'red' : 'black';
}

function renderCard(card, selectable = false) {
  const div = document.createElement('div');
  div.className = `card ${suitColor(card.suit)}${selectable ? ' hand-card' : ''}`;
  div.dataset.id = card.id;
  if (card.rank === 'JB' || card.rank === 'JR') {
    const emoji = card.rank === 'JB' ? 'üÉè' : 'üÉü';
    div.innerHTML = `<div class="corner tl">${card.rank}</div><div class="rank">${emoji}</div><div class="corner br">${card.rank}</div>`;
  } else {
    div.innerHTML = `<div class="corner tl">${card.rank}<br>${card.suit}</div><div class="rank">${card.rank}</div><div class="suit">${card.suit}</div><div class="corner br">${card.rank}<br>${card.suit}</div>`;
  }
  return div;
}

function comboName(combo) {
  if (!combo) return '';
  const names = { single:'–û–¥–∏–Ω–æ—á–Ω–∞—è', pair:'–ü–∞—Ä–∞', triple:'–¢—Ä–æ–π–Ω–∏–∫', quad:'–ö–∞—Ä–µ', katarik:'–ö–∞—Ç–∞—Ä–∏–∫', sanzhud:'–°–∞–Ω–¥–∂—É–¥' };
  const RANKS = ['4','5','6','7','8','9','10','B','D','K','A','2','3','JB','JR'];
  let base = names[combo.type] || combo.type;
  if (combo.rank) base += ` (${combo.rank})`;
  if ((combo.type === 'katarik' || combo.type === 'sanzhud') && combo.minVal !== undefined)
    base += ` (${RANKS[combo.minVal]}‚Ä¶${RANKS[combo.maxVal]})`;
  return base;
}

function renderHand() {
  const container = document.getElementById('hand-cards');
  container.innerHTML = '';
  document.getElementById('hand-count').textContent = hand.length;
  const RANK_VAL = {};
  ['4','5','6','7','8','9','10','B','D','K','A','2','3','JB','JR'].forEach((r,i) => RANK_VAL[r]=i);
  const sorted = [...hand].sort((a,b) => (RANK_VAL[a.rank]||0)-(RANK_VAL[b.rank]||0) || a.suit.localeCompare(b.suit));
  for (const card of sorted) {
    const div = renderCard(card, true);
    if (selectedIds.has(card.id)) div.classList.add('selected');
    if (!isMyTurn) div.classList.add('disabled');
    div.addEventListener('click', () => {
      if (!isMyTurn) return;
      selectedIds.has(card.id) ? selectedIds.delete(card.id) : selectedIds.add(card.id);
      div.classList.toggle('selected');
      updateSelectionInfo();
    });
    container.appendChild(div);
  }
  updateSelectionInfo();
}

function renderTableCards(cards) {
  const container = document.getElementById('table-cards');
  container.innerHTML = '';
  if (cards) for (const card of cards) container.appendChild(renderCard(card));
}

function updateSelectionInfo() {
  const n = selectedIds.size;
  document.getElementById('selection-info').textContent = n > 0 ? `–í—ã–±—Ä–∞–Ω–æ –∫–∞—Ä—Ç: ${n}` : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—ã –¥–ª—è —Ö–æ–¥–∞';
  document.getElementById('btn-play').disabled = !isMyTurn || n === 0;
  document.getElementById('btn-pass').disabled = !isMyTurn || !gameState?.tablePlay;
}

function updateGameUI() {
  if (!gameState) return;
  const currentId = gameState.currentPlayerId;
  isMyTurn = currentId === myId;
  const statusEl = document.getElementById('status-msg');
  if (isMyTurn) {
    statusEl.textContent = gameState.tablePlay ? '–í–∞—à —Ö–æ–¥ ‚Äî –±–µ–π—Ç–µ –∏–ª–∏ –ø–∞—Å—É–π—Ç–µ' : '–í–∞—à —Ö–æ–¥ ‚Äî –Ω–∞—á–∏–Ω–∞–π—Ç–µ';
    statusEl.style.color = 'var(--accent)';
  } else {
    const cp = gameState.players.find(p => p.id === currentId);
    statusEl.textContent = cp ? `–•–æ–¥: ${cp.name}` : '–û–∂–∏–¥–∞–Ω–∏–µ...';
    statusEl.style.color = 'var(--text-dim)';
  }
  renderTableCards(gameState.tablePlay?.cards);
  const comboInfo = document.getElementById('combo-info');
  comboInfo.textContent = gameState.tablePlay
    ? `–ù–∞ —Å—Ç–æ–ª–µ: ${comboName(gameState.tablePlay.combination)} ¬∑ ${gameState.tablePlay.cards?.length || 0} –∫–∞—Ä—Ç`
    : '–°—Ç–æ–ª –ø—É—Å—Ç';
  const oppArea = document.getElementById('opponents-area');
  oppArea.innerHTML = '';
  for (const p of gameState.players) {
    if (p.id === myId) continue;
    const badge = document.createElement('div');
    badge.className = 'player-badge' + (p.id === currentId ? ' active' : '') + (p.finished ? ' finished' : '');
    badge.innerHTML = `<div class="turn-indicator"></div><span class="pname">${p.name}</span><span class="pcards">${p.cardCount}–∫</span>${p.finishRank ? `<span class="prank">#${p.finishRank}</span>` : ''}${!p.connected ? '<span style="color:#c0392b;font-size:0.6rem">‚äò</span>' : ''}`;
    oppArea.appendChild(badge);
  }
  renderHand();
  updateSelectionInfo();
}

function updateLobbyPlayers(players) {
  const list = document.getElementById('lobby-player-list');
  list.innerHTML = '';
  for (const p of players) {
    const div = document.createElement('div');
    div.className = 'lobby-player';
    div.textContent = p.name + (!p.connected ? ' (–æ—Ç–∫–ª—é—á—ë–Ω)' : '');
    list.appendChild(div);
  }
  document.getElementById('btn-start').disabled = players.filter(p=>p.connected).length < 3;
}

let toastTimer;
function showError(msg) {
  const toast = document.getElementById('error-toast');
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
}

function addChat(playerName, text, isSystem = false) {
  const msgs = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'chat-msg' + (isSystem ? ' system' : '');
  div.innerHTML = isSystem ? esc(text) : `<span class="cn">${esc(playerName)}: </span>${esc(text)}`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function showGameOver(data) {
  const results = document.getElementById('overlay-results');
  const medals = ['ü•á','ü•à','ü•â'];
  results.innerHTML = '';
  [...data.players].sort((a,b)=>(a.finishRank||99)-(b.finishRank||99)).forEach(p => {
    const div = document.createElement('div');
    div.className = 'result-item';
    div.innerHTML = `<div class="result-rank ${p.finishRank<=3?'rank-'+p.finishRank:''}">${medals[p.finishRank-1]||p.finishRank}</div><div class="result-name">${esc(p.name)}</div>`;
    results.appendChild(div);
  });
  document.getElementById('overlay').classList.add('show');
}

function connect() {
  const name = document.getElementById('input-name').value.trim();
  const room = document.getElementById('input-room').value.trim() || 'default';
  if (!name) { showError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
  myName = name; myRoomId = room;
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${protocol}//${location.host}`);
  ws.onopen = () => {
    if (!myId) { myId = `p_${Date.now()}_${Math.random().toString(36).slice(2)}`; local
